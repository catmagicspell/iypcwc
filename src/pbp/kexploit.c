#include <stdio.h>
#include <stdlib.h>
#include <pspsysmem_kernel.h>
#include <libpspexploit.h>
#include <common.h>

int gen, baryon, tachyon;

static KernelFunctions _ktbl; KernelFunctions*k_tbl = &_ktbl;
int (*_sceSysconGetBaryonVersion)(int*) = NULL;
int (*_sceSysregGetTachyonVersion)(void) = NULL;
int (*_sceKernelDelayThread)(int) = NULL;
int (*_sceKernelExitDeleteThread)(int) = NULL;
int (*_sceKernelGetModel)(void) = NULL;

int kexploitKernelGetModel(void) {
	int k1 = pspSdkSetK1(0);
	int g = _sceKernelGetModel();
	pspSdkSetK1(k1);
	return g;
}

int kexploitSysregGetTachyonVersion(void) {
	int k1 = pspSdkSetK1(0);
	int sv = _sceSysregGetTachyonVersion();
	pspSdkSetK1(k1);
	return sv;
}

int kthread(void) {
	gen = kexploitKernelGetModel() + 1;
	_sceSysconGetBaryonVersion(&baryon);
	tachyon = kexploitSysregGetTachyonVersion();

	switch(tachyon) {
		case 0x00600000: {
			switch(baryon) {
				case 0x00243000: {
					BackColor(RED);
					printf("ta-088v3! CANNOT install Classic cIPL");
					break;
				}
			}
			break;
		}

		default: {
			BackColor(GREEN);
			printf("NOT ta-088v3!\n");
			if (gen == 1 || gen == 2){
				printf("01g/02g! can install Classic cIPL");
			}
			else {
				BackColor(RED);
				printf("NOT 01g/02g! CANNOT install Classic cIPL");
			}
			break;
		}
	}
	BackColor(BLACK);
	TextColor(YELLOW);
	printf("\n\nGeneration : %02ig\n", gen);
	printf("Tachyon : 0x%08x\n", tachyon);
	printf("Baryon : 0x%08x\n\n", baryon);

	printf(" Exiting in 10 seconds...");

	_sceKernelDelayThread(10*1000*1000);

	_sceKernelExitDeleteThread(0);
	return 0;
}

void kmain() {
	int k1 = pspSdkSetK1(0);
	int userlevel = pspXploitSetUserLevel(8);

	pspXploitRepairKernel();
	pspXploitScanKernelFunctions(k_tbl);
	char*sysreg_mod = (pspXploitFindTextAddrByName("sceLowIO_Driver") == 0) ? "sceSYSREG_Driver" : "sceLowIO_Driver";

	_sceSysregGetTachyonVersion = pspXploitFindFunction(sysreg_mod, "sceSysreg_driver", 0xE2A5D1EE);
	_sceSysconGetBaryonVersion = pspXploitFindFunction("sceSYSCON_Driver", "sceSyscon_driver", 0x7EC5A957);
	_sceKernelExitDeleteThread = pspXploitFindFunction("sceThreadManager", "ThreadManForUser", 0x809CE29B);
	_sceKernelDelayThread = pspXploitFindFunction("sceThreadManager", "ThreadManForUser", 0xCEADEB47);
	_sceKernelGetModel = pspXploitFindFunction("sceSystemMemoryManager", "SysMemForKernel", /*0x6373995D*/ 0x07C586A1);

	SceUID kthreadID = k_tbl->KernelCreateThread("iypcwc_kthread", (void*)KERNELIFY(&kthread), 1, 0x20000, PSP_THREAD_ATTR_VFPU, NULL);
	if (kthreadID >= 0){
		k_tbl->KernelStartThread(kthreadID, 0, NULL);
		k_tbl->waitThreadEnd(kthreadID, NULL);
	}

	pspXploitSetUserLevel(userlevel);
	pspSdkSetK1(k1);
}